<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìƒˆ ê¿ˆ ê¸°ë¡ - ê¿ˆ ë¶„ì„ê¸°</title>
    <link rel="stylesheet" href="/styles/main.css">
</head>

<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="navbar-content">
            <a href="/dashboard.html" class="navbar-brand">ğŸŒ™ ê¿ˆ ë¶„ì„ê¸°</a>
            <ul class="navbar-nav">
                <li><a href="/dashboard.html" class="navbar-link">ëŒ€ì‹œë³´ë“œ</a></li>
                <li><a href="/dream-journal.html" class="navbar-link">ê¿ˆ ì¼ì§€</a></li>
                <li><a href="#" class="navbar-link" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</a></li>
            </ul>
        </div>
    </nav>

    <div class="container-narrow" style="margin-top: 2rem;">
        <h1 class="mb-lg">âœ¨ ìƒˆ ê¿ˆ ê¸°ë¡</h1>

        <div class="card card-premium">
            <form onsubmit="handleDreamSubmission(event)">
                <div class="form-group">
                    <label class="form-label" for="dreamDate">ë‚ ì§œ</label>
                    <input type="date" id="dreamDate" class="form-input" required>
                </div>

                <div class="form-group">
                    <label class="form-label" for="dreamTitle">ê¿ˆ ì œëª©</label>
                    <input type="text" id="dreamTitle" class="form-input" placeholder="ì˜ˆ: ë°”ë‹¤ë¥¼ ê±´ë„ˆëŠ” ê¿ˆ" required>
                </div>

                <div class="form-group">
                    <label class="form-label" for="dreamContent">ê¿ˆ ë‚´ìš©</label>
                    <textarea id="dreamContent" class="form-textarea"
                        placeholder="ê°€ëŠ¥í•œ í•œ ìƒì„¸í•˜ê²Œ ê¿ˆì˜ ë‚´ìš©ì„ ê¸°ë¡í•˜ì„¸ìš”. ë“±ì¥ì¸ë¬¼, ì¥ì†Œ, ê°ì •, ìƒì§•ì  ìš”ì†Œë“¤ì„ ëª¨ë‘ í¬í•¨í•´ì£¼ì„¸ìš”..." required></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label">ê°ì • íƒœê·¸ (ì„ íƒì‚¬í•­)</label>
                    <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 0.5rem;">
                        <label style="display: flex; align-items: center; gap: 0.3rem; cursor: pointer;">
                            <input type="checkbox" value="ê¸°ì¨" name="emotions"> ê¸°ì¨
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.3rem; cursor: pointer;">
                            <input type="checkbox" value="ìŠ¬í””" name="emotions"> ìŠ¬í””
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.3rem; cursor: pointer;">
                            <input type="checkbox" value="ë‘ë ¤ì›€" name="emotions"> ë‘ë ¤ì›€
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.3rem; cursor: pointer;">
                            <input type="checkbox" value="ë¶„ë…¸" name="emotions"> ë¶„ë…¸
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.3rem; cursor: pointer;">
                            <input type="checkbox" value="ë¶ˆì•ˆ" name="emotions"> ë¶ˆì•ˆ
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.3rem; cursor: pointer;">
                            <input type="checkbox" value="í‰ì˜¨" name="emotions"> í‰ì˜¨
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.3rem; cursor: pointer;">
                            <input type="checkbox" value="í˜¼ë€" name="emotions"> í˜¼ë€
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.3rem; cursor: pointer;">
                            <input type="checkbox" value="í¬ë§" name="emotions"> í¬ë§
                        </label>
                    </div>
                </div>

                <div id="submitError" class="hidden" style="color: var(--color-error); margin-bottom: 1rem;"></div>

                <div style="display: flex; gap: 1rem;">
                    <button type="submit" class="btn btn-accent" style="flex: 1;">ğŸ’¾ ì €ì¥í•˜ê¸°</button>
                    <button type="button" class="btn btn-outline"
                        onclick="window.location.href='/dashboard.html'">ì·¨ì†Œ</button>
                </div>
            </form>
        </div>
    </div>

    <script src="/js/app.js"></script>
    <script>
        // Check authentication
        if (!isAuthenticated()) {
            window.location.href = '/auth.html';
        }

        // Set default date to today
        document.getElementById('dreamDate').valueAsDate = new Date();

        // Handle form submission
        async function handleDreamSubmission(event) {
            event.preventDefault();

            const date = document.getElementById('dreamDate').value;
            const title = document.getElementById('dreamTitle').value;
            const content = document.getElementById('dreamContent').value;

            // Get selected emotions
            const emotionCheckboxes = document.querySelectorAll('input[name="emotions"]:checked');
            const emotions = Array.from(emotionCheckboxes).map(cb => cb.value);

            const errorDiv = document.getElementById('submitError');
            const submitButton = event.target.querySelector('button[type="submit"]');

            try {
                submitButton.disabled = true;
                submitButton.textContent = 'ì €ì¥ ì¤‘...';

                const response = await authenticatedFetch(`${API_URL}/dreams`, {
                    method: 'POST',
                    body: JSON.stringify({
                        date,
                        title,
                        content,
                        emotions
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'ê¿ˆ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
                }

                // Ask if user wants to analyze the dream
                const analyze = confirm('ê¿ˆì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤! ì§€ê¸ˆ ë°”ë¡œ AI ë¶„ì„ì„ ë°›ìœ¼ì‹œê² ìŠµë‹ˆê¹Œ?');

                if (analyze) {
                    // Redirect to analysis
                    window.location.href = `/analysis-result.html?dreamId=${data.dreamId}&analyze=true`;
                } else {
                    // Redirect to dashboard
                    window.location.href = '/dashboard.html';
                }

            } catch (error) {
                errorDiv.textContent = error.message;
                errorDiv.classList.remove('hidden');
                submitButton.disabled = false;
                submitButton.textContent = 'ğŸ’¾ ì €ì¥í•˜ê¸°';
            }
        }
    </script>
</body>

</html>