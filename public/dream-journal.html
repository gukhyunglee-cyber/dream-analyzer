<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê¿ˆ ì¼ì§€ - ê¿ˆ ë¶„ì„ê¸°</title>
    <link rel="stylesheet" href="/styles/main.css">
</head>

<body>
    <nav class="navbar">
        <div class="navbar-content">
            <a href="/index.html" class="navbar-brand">ğŸŒ™ ê¿ˆ ë¶„ì„ê¸°</a>
            <li><a href="/dashboard.html" class="navbar-link">ëŒ€ì‹œë³´ë“œ</a></li>
            <li><a href="/dream-journal.html" class="navbar-link">ê¿ˆ ì¼ì§€</a></li>
            <li><a href="/community.html" class="navbar-link">ì»¤ë®¤ë‹ˆí‹° (ê²Œì‹œíŒ)</a></li>
            <li id="nav-auth-section">
                <!-- Auth content injected via JS -->
            </li>
        </div>
    </nav>

    <div class="container" style="margin-top: 2rem;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
            <h1>ğŸ“– ê¿ˆ ì¼ì§€</h1>
            <a href="/dream-input.html" class="btn btn-accent">+ ìƒˆ ê¿ˆ ê¸°ë¡</a>
        </div>

        <!-- Filters -->
        <div class="card mb-lg" style="padding: 1rem;">
            <div style="display: flex; gap: 1rem; flex-wrap: wrap; align-items: center;">
                <div>
                    <label class="form-label" style="margin-bottom: 0.25rem; font-size: 0.9rem;">ì •ë ¬</label>
                    <select id="sortOrder" class="form-select" onchange="loadDreams()" style="padding: 0.5rem;">
                        <option value="date_desc">ìµœì‹ ìˆœ</option>
                        <option value="date_asc">ì˜¤ë˜ëœ ìˆœ</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Dreams List -->
        <div id="dreamsList"></div>
    </div>

    <!-- Global Footer -->
    <footer
        style="margin-top: 4rem; padding: 2rem; border-top: 1px solid var(--glass-border); text-align: center; color: var(--color-text-muted);">
        <div style="display: flex; justify-content: center; gap: 1.5rem; margin-bottom: 1rem; flex-wrap: wrap;">
            <a href="/about.html" style="color: var(--color-text-secondary); text-decoration: none;">ì„œë¹„ìŠ¤ ì†Œê°œ</a>
            <a href="/terms.html" style="color: var(--color-text-secondary); text-decoration: none;">ì´ìš©ì•½ê´€</a>
            <a href="/privacy.html" style="color: var(--color-text-secondary); text-decoration: none;">ê°œì¸ì •ë³´ ì²˜ë¦¬ë°©ì¹¨</a>
        </div>
        <p style="font-size: 0.9rem;">&copy; 2024 Dream Analyzer. All rights reserved.</p>
    </footer>

    <script src="/js/app.js"></script>
    <script>
        // Check authentication
        if (!isAuthenticated()) {
            window.location.href = '/auth.html';
        }

        // Setup authenticated navigation
        document.addEventListener('DOMContentLoaded', async () => {
            const authSection = document.getElementById('nav-auth-section');
            if (!authSection) return;

            if (isAuthenticated()) {
                try {
                    const res = await authenticatedFetch(`${API_URL}/auth/me`);
                    const user = await res.json();
                    if (res.ok) {
                        const avatarUrl = user.profile_image_url || 'https://api.dicebear.com/7.x/avataaars/svg?seed=' + user.username;
                        const displayName = user.nickname || user.username;

                        authSection.innerHTML = `
                            <div class="user-profile-widget" style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; position: relative;" onclick="toggleProfileMenu(event)">
                                <img src="${avatarUrl}" alt="Profile" style="width: 32px; height: 32px; border-radius: 50%; border: 2px solid var(--color-primary-light); object-fit: cover;">
                                <span style="color: var(--color-text); font-weight: 500; font-size: 0.95rem;">${displayName}</span>
                                
                                <div id="nav-profile-menu" style="display: none; position: absolute; top: 120%; right: 0; background: var(--color-surface); border: 1px solid var(--glass-border); border-radius: var(--radius-sm); padding: 0.5rem 0; min-width: 150px; box-shadow: var(--shadow-md); z-index: 1000;">
                                    <a href="/dashboard.html" style="display: block; padding: 0.5rem 1rem; color: var(--color-text); text-decoration: none; font-size: 0.9rem;">ë‚´ ì •ë³´</a>
                                    <div style="height: 1px; background: var(--glass-border); margin: 0.25rem 0;"></div>
                                    <a href="#" onclick="logout(); return false;" style="display: block; padding: 0.5rem 1rem; color: var(--color-error); text-decoration: none; font-size: 0.9rem;">ë¡œê·¸ì•„ì›ƒ</a>
                                </div>
                            </div>
                        `;
                    }
                } catch (e) {
                    console.error('Failed to load user for nav', e);
                    authSection.innerHTML = '<li><a href="#" class="navbar-link" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</a></li>';
                }
            } else {
                authSection.innerHTML = '<li><a href="/auth.html" class="navbar-link">ë¡œê·¸ì¸</a></li>';
            }
        });

        function toggleProfileMenu(e) {
            e.stopPropagation();
            const menu = document.getElementById('nav-profile-menu');
            if (menu.style.display === 'none' || !menu.style.display) {
                // close others if they existed
                menu.style.display = 'block';
            } else {
                menu.style.display = 'none';
            }
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', () => {
            const menu = document.getElementById('nav-profile-menu');
            if (menu) menu.style.display = 'none';
        });

        // Load all dreams
        async function loadDreams() {
            const listElement = document.getElementById('dreamsList');
            const sortOrder = document.getElementById('sortOrder').value;

            showLoading('dreamsList');

            try {
                const response = await authenticatedFetch(`${API_URL}/dreams`);
                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'ê¿ˆ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                }

                let dreams = data.dreams;

                // Apply sorting
                if (sortOrder === 'date_asc') {
                    dreams = dreams.reverse();
                }

                if (dreams.length === 0) {
                    listElement.innerHTML = `
            <div class="card text-center">
              <div style="font-size: 4rem; margin-bottom: 1rem;">ğŸŒ™</div>
              <h2>ì•„ì§ ê¸°ë¡ëœ ê¿ˆì´ ì—†ìŠµë‹ˆë‹¤</h2>
              <p class="text-muted mb-md">ì²« ë²ˆì§¸ ê¿ˆì„ ê¸°ë¡í•˜ê³  ë¬´ì˜ì‹ì˜ ë©”ì‹œì§€ë¥¼ ë°œê²¬í•˜ì„¸ìš”</p>
              <a href="/dream-input.html" class="btn btn-accent">ì²« ê¿ˆ ê¸°ë¡í•˜ê¸°</a>
            </div>
          `;
                    return;
                }

                // Display dreams
                listElement.innerHTML = dreams.map(dream => `
          <div class="card fade-in" style="margin-bottom: 1.5rem; cursor: pointer;" onclick="viewDream(${dream.id})">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
              <h3 style="margin: 0;">${dream.title}</h3>
              <button onclick="event.stopPropagation(); deleteDream(${dream.id}, '${dream.title}')" class="btn" style="background: var(--color-error); color: white; padding: 0.5rem 1rem; font-size: 0.85rem;">ì‚­ì œ</button>
            </div>
            
            <p class="text-muted" style="font-size: 0.9rem; margin-bottom: 1rem;">
              ğŸ“… ${formatDate(dream.date)}
            </p>
            
            <p style="color: var(--color-text-secondary); margin-bottom: 1rem; overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical;">
              ${dream.content}
            </p>
            
            ${dream.emotions && dream.emotions.length > 0 ? `
              <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-bottom: 1rem;">
                ${dream.emotions.map(e => `
                  <span style="background: var(--color-primary-light); padding: 0.25rem 0.75rem; border-radius: 1rem; font-size: 0.85rem;">${e}</span>
                `).join('')}
              </div>
            ` : ''}

            ${dream.analysis && Object.keys(dream.analysis).length > 0 ? `
              <div style="background: var(--color-surface); padding: 1rem; border-radius: var(--radius-sm); margin-bottom: 1rem; border-left: 3px solid var(--color-accent);">
                <h4 style="color: var(--color-accent); margin-bottom: 0.5rem; font-size: 0.95rem;">ğŸŒŸ ë‚´ë©´ ì„±ì¥ì„ ìœ„í•œ ì¡°ì–¸</h4>
                <p style="font-size: 0.9rem; color: var(--color-text); margin-bottom: 1rem;">${dream.analysis.individuation_insights || 'ë¶„ì„ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.'}</p>
                <h4 style="color: var(--color-accent-light); margin-bottom: 0.5rem; font-size: 0.95rem;">ğŸ’¡ ì„±ì°° ì œì•ˆ</h4>
                <p style="font-size: 0.9rem; color: var(--color-text); margin-bottom: 0;">${dream.analysis.recommendations || 'ì œì•ˆëœ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.'}</p>
              </div>
            ` : ''}
            
            <div style="padding-top: 1rem; border-top: 1px solid var(--glass-border); display: flex; justify-content: space-between; align-items: center;">
              <div>
                <button onclick="event.stopPropagation(); togglePublicStatus(${dream.id}, ${!dream.is_public})" class="btn" style="padding: 0.3rem 0.8rem; font-size: 0.85rem; background: ${dream.is_public ? 'var(--color-surface-light)' : 'var(--glass-bg)'}; border: 1px solid ${dream.is_public ? 'var(--color-primary)' : 'var(--glass-border)'}; color: var(--color-text);">
                  ${dream.is_public ? 'ğŸŒ ê³µê°œë¨ (ê²Œì‹œíŒ ê³µìœ ì¤‘)' : 'ğŸ”’ ë‚˜ë§Œ ë³´ê¸°'}
                </button>
              </div>
              <span style="color: var(--color-accent); font-weight: 500;">ìì„¸íˆ ë³´ê¸° â†’</span>
            </div>
          </div>
        `).join('');

            } catch (error) {
                showError('dreamsList', error.message);
            }
        }

        // View dream details
        function viewDream(dreamId) {
            window.location.href = `/analysis-result.html?dreamId=${dreamId}`;
        }

        // Delete dream
        async function deleteDream(dreamId, title) {
            if (!confirm(`ì •ë§ë¡œ "${title}" ê¿ˆì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`)) {
                return;
            }

            try {
                const response = await authenticatedFetch(`${API_URL}/dreams/${dreamId}`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
                }

                alert('ê¿ˆì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                loadDreams(); // Reload the list

            } catch (error) {
                alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }

        // Toggle public status of a dream
        async function togglePublicStatus(dreamId, makePublic) {
            try {
                const response = await authenticatedFetch(`${API_URL}/community/${dreamId}/visibility`, {
                    method: 'PUT',
                    body: JSON.stringify({ isPublic: makePublic })
                });

                if (response.ok) {
                    loadDreams(); // reload the list to show updated status
                } else {
                    const data = await response.json();
                    alert(data.error || 'ìƒíƒœ ë³€ê²½ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
            } catch (e) {
                console.error('Toggle error:', e);
                alert('ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // Load dreams on page load
        loadDreams();
    </script>
</body>

</html>