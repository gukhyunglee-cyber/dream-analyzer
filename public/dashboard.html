<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ëŒ€ì‹œë³´ë“œ - ê¿ˆ ë¶„ì„ê¸°</title>
    <link rel="stylesheet" href="/styles/main.css">
</head>

<body>
    <nav class="navbar">
        <div class="navbar-content">
            <a href="/index.html" class="navbar-brand">ğŸŒ™ ê¿ˆ ë¶„ì„ê¸°</a>
            <ul class="navbar-nav" style="align-items: center;">
                <li><a href="/dashboard.html" class="navbar-link">ëŒ€ì‹œë³´ë“œ</a></li>
                <li><a href="/dream-journal.html" class="navbar-link">ê¿ˆ ì¼ì§€</a></li>
                <li><a href="/community.html" class="navbar-link">ì»¤ë®¤ë‹ˆí‹° (ê²Œì‹œíŒ)</a></li>
                <li><a href="#" class="navbar-link" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</a></li>
                <li style="display: flex; align-items: center; cursor: pointer; margin-left: 1rem;"
                    onclick="openProfileModal()">
                    <div id="navProfileImage"
                        style="width: 35px; height: 35px; border-radius: 50%; background-color: var(--color-surface-light); background-size: cover; background-position: center; border: 2px solid var(--color-accent);">
                    </div>
                </li>
            </ul>
        </div>
    </nav>

    <div class="container">
        <!-- Dashboard Top Fold: Welcome & Stats -->
        <div
            style="display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; margin-top: 2rem; gap: 2rem;">
            <!-- Welcome Section -->
            <section class="welcome" style="flex: 1; min-width: 300px;">
                <h1 id="welcomeText" style="font-size: 2.5rem; margin-bottom: 0.5rem;">í™˜ì˜í•©ë‹ˆë‹¤</h1>
                <p class="text-muted">ë‹¹ì‹ ì˜ ë¬´ì˜ì‹ì„ íƒí—˜í•˜ê³  ê¿ˆì˜ ë©”ì‹œì§€ë¥¼ ë°œê²¬í•˜ì„¸ìš”</p>
                <div class="mt-md">
                    <a href="/dream-input.html" class="btn btn-accent"
                        style="font-size: 1.1rem; padding: 0.8rem 1.5rem;">
                        âœ¨ ìƒˆ ê¿ˆ ê¸°ë¡í•˜ê¸°
                    </a>
                </div>
            </section>

            <!-- Stats Section -->
            <section class="stats" style="display: flex; gap: 1rem; flex-wrap: wrap;">
                <div class="card text-center" style="padding: 1rem; cursor: pointer; min-width: 130px;"
                    onclick="openDreamsModal()">
                    <div style="font-size: 1.8rem; color: var(--color-accent);">ğŸ“</div>
                    <h3 id="totalDreams" style="font-size: 1.5rem; margin: 0.5rem 0;">0</h3>
                    <p class="text-muted" style="font-size: 0.85rem; margin: 0;">ì´ ê¿ˆ ê¸°ë¡(í†µê³„ë³´ê¸°)</p>
                </div>
                <div class="card text-center" style="padding: 1rem; cursor: pointer; min-width: 130px;"
                    onclick="openAnalysisModal()">
                    <div style="font-size: 1.8rem; color: var(--color-primary-light);">ğŸ”®</div>
                    <h3 id="totalAnalyses" style="font-size: 1.5rem; margin: 0.5rem 0;">0</h3>
                    <p class="text-muted" style="font-size: 0.85rem; margin: 0;">ë¶„ì„ ì™„ë£Œ(í†µê³„ë³´ê¸°)</p>
                </div>
                <div class="card text-center"
                    style="padding: 1rem; cursor: pointer; min-width: 130px; background: rgba(139, 92, 246, 0.05);"
                    onclick="openDemographicsModal()">
                    <div style="font-size: 1.8rem; color: var(--color-secondary);">ğŸ‘¥</div>
                    <h3 id="totalPlatformUsers" style="font-size: 1.5rem; margin: 0.5rem 0;">0</h3>
                    <p class="text-muted" style="font-size: 0.85rem; margin: 0;">ì „ì²´ ê°€ì…ì(ìƒì„¸í†µê³„)</p>
                </div>
            </section>
        </div>

        <!-- Recent Dreams -->
        <section class="recent-dreams" style="margin-top: 3rem;">
            <h2 class="mb-md">ìµœê·¼ ê¿ˆ</h2>
            <div id="recentDreamsList"></div>
        </section>
    </div>

    <!-- Modals -->
    <!-- Profile Edit Modal -->
    <div id="profileModal" class="modal hidden">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModals()">&times;</button>
            <h2 class="mb-md text-center">ê°œì¸ì •ë³´ ìˆ˜ì •</h2>
            <form id="profileForm" onsubmit="handleProfileSubmit(event)">
                <div class="avatar-preview-container" id="avatarPreview"
                    onclick="document.getElementById('profileImageUpload').click()">
                    <span style="font-size: 2rem; color: rgba(255,255,255,0.3);" id="avatarPlaceholder">ğŸ‘¤</span>
                </div>
                <div class="text-center text-muted" style="font-size: 0.8rem; margin-bottom: 1rem;">í´ë¦­í•˜ì—¬ í”„ë¡œí•„ ì‚¬ì§„ ë“±ë¡</div>
                <input type="file" id="profileImageUpload" accept="image/*" style="display: none;"
                    onchange="previewAvatar(event)">

                <div class="form-group mb-sm">
                    <label class="form-label" for="profileNickname">ë³„ëª… (ê²Œì‹œíŒ í‘œì‹œìš©)</label>
                    <input type="text" id="profileNickname" class="form-input" placeholder="ìƒˆë¡œìš´ ë³„ëª…ì„ ì…ë ¥í•˜ì„¸ìš”">
                </div>

                <div class="form-group mb-sm">
                    <label class="form-label" for="profileEmail">ì´ë©”ì¼</label>
                    <input type="email" id="profileEmail" class="form-input" placeholder="ì´ë©”ì¼ ì…ë ¥">
                </div>

                <div class="form-group mb-sm">
                    <label class="form-label" for="profilePassword">ìƒˆ ë¹„ë°€ë²ˆí˜¸ (ë³€ê²½ ì›ì¹˜ ì•ŠìŒ ì‹œ ë¹ˆì¹¸ ìœ ì§€)</label>
                    <input type="password" id="profilePassword" class="form-input" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ (ì„ íƒ)">
                </div>

                <div class="form-group mb-sm">
                    <label class="form-label" for="profileBirthDate">ìƒë…„ì›”ì¼</label>
                    <input type="date" id="profileBirthDate" class="form-input">
                </div>

                <div class="form-group mb-lg">
                    <label class="form-label" for="profileGender">ì„±ë³„</label>
                    <select id="profileGender" class="form-select">
                        <option value="">ì„ íƒ ì•ˆí•¨</option>
                        <option value="ë‚¨ì„±">ë‚¨ì„±</option>
                        <option value="ì—¬ì„±">ì—¬ì„±</option>
                        <option value="ê¸°íƒ€">ê¸°íƒ€</option>
                    </select>
                </div>

                <div id="profileMessage" style="margin-bottom: 1rem; font-size: 0.9rem;"></div>
                <button type="submit" class="btn btn-primary" style="width: 100%;" id="btnUpdateProfile">í”„ë¡œí•„ ìˆ˜ì •
                    ì™„ë£Œ</button>
            </form>
        </div>
    </div>

    <!-- User Dreams List Modal -->
    <div id="dreamsModal" class="modal hidden">
        <div class="modal-content" style="max-width: 600px;">
            <button class="modal-close" onclick="closeModals()">&times;</button>
            <h2 class="mb-md" style="color: var(--color-accent);">ğŸ“ ë‚´ê°€ ê¸°ë¡í•œ ê¿ˆ ëª©ë¡</h2>
            <div id="modalDreamsContent" style="max-height: 50vh; overflow-y: auto;">
                <div class="loading" style="height: 100px;"></div>
            </div>
        </div>
    </div>

    <!-- User Analyzed Dreams Modal -->
    <div id="analysisModal" class="modal hidden">
        <div class="modal-content" style="max-width: 600px;">
            <button class="modal-close" onclick="closeModals()">&times;</button>
            <h2 class="mb-md" style="color: var(--color-primary-light);">ğŸ”® ë¶„ì„ ì™„ë£Œëœ ê¿ˆ ëª©ë¡</h2>
            <div id="modalAnalysisContent" style="max-height: 50vh; overflow-y: auto;">
                <div class="loading" style="height: 100px;"></div>
            </div>
        </div>
    </div>

    <!-- Demographics Modal -->
    <div id="demoModal" class="modal hidden">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModals()">&times;</button>
            <h2 class="mb-md" style="color: var(--color-secondary);">ğŸ‘¥ ì „ì²´ ìœ ì € í†µê³„</h2>
            <div id="modalDemoContent">
                <div class="loading" style="height: 200px;"></div>
            </div>
        </div>
    </div>

    <!-- Global Footer -->
    <footer
        style="margin-top: 4rem; padding: 2rem; border-top: 1px solid var(--glass-border); text-align: center; color: var(--color-text-muted);">
        <div style="display: flex; justify-content: center; gap: 1.5rem; margin-bottom: 1rem; flex-wrap: wrap;">
            <a href="/about.html" style="color: var(--color-text-secondary); text-decoration: none;">ì„œë¹„ìŠ¤ ì†Œê°œ</a>
            <a href="/terms.html" style="color: var(--color-text-secondary); text-decoration: none;">ì´ìš©ì•½ê´€</a>
            <a href="/privacy.html" style="color: var(--color-text-secondary); text-decoration: none;">ê°œì¸ì •ë³´ ì²˜ë¦¬ë°©ì¹¨</a>
        </div>
        <p style="font-size: 0.9rem;">&copy; 2024 Dream Analyzer. All rights reserved.</p>
    </footer>

    <script src="/js/app.js"></script>
    <script>
        // Check authentication
        if (!isAuthenticated()) {
            window.location.href = '/auth.html';
        }

        let allDreamsCached = []; // Cache to avoid refetching

        // Display user name and profile
        function updateUIAfterLoad() {
            const user = getUser();
            if (user) {
                document.getElementById('welcomeText').textContent = `í™˜ì˜í•©ë‹ˆë‹¤, ${user.nickname || user.username}ë‹˜`;
                document.getElementById('profileNickname').value = user.nickname || '';
                document.getElementById('profileEmail').value = user.email || '';
                document.getElementById('profileBirthDate').value = user.birth_date || '';
                document.getElementById('profileGender').value = user.gender || '';

                const profileImgElement = document.getElementById('navProfileImage');
                if (user.profile_image_url) {
                    profileImgElement.style.backgroundImage = `url(${user.profile_image_url})`;

                    const avatarPreview = document.getElementById('avatarPreview');
                    avatarPreview.style.backgroundImage = `url(${user.profile_image_url})`;
                    document.getElementById('avatarPlaceholder').style.display = 'none';
                }
            }
        }
        updateUIAfterLoad();

        // ------------------------------
        // Modals Logic
        // ------------------------------
        function closeModals() {
            document.querySelectorAll('.modal').forEach(m => m.classList.add('hidden'));
        }

        function openProfileModal() {
            closeModals();
            document.getElementById('profileMessage').textContent = '';
            document.getElementById('profileModal').classList.remove('hidden');
        }

        function previewAvatar(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    const preview = document.getElementById('avatarPreview');
                    preview.style.backgroundImage = `url(${e.target.result})`;
                    document.getElementById('avatarPlaceholder').style.display = 'none';
                }
                reader.readAsDataURL(file);
            }
        }

        async function handleProfileSubmit(event) {
            event.preventDefault();
            const nickname = document.getElementById('profileNickname').value;
            const email = document.getElementById('profileEmail').value;
            const password = document.getElementById('profilePassword').value;
            const birth_date = document.getElementById('profileBirthDate').value;
            const gender = document.getElementById('profileGender').value;

            const imageFile = document.getElementById('profileImageUpload').files[0];
            const msgDiv = document.getElementById('profileMessage');

            msgDiv.textContent = '';
            msgDiv.style.color = 'var(--color-text-primary)';

            if (!nickname || nickname.trim() === '') {
                msgDiv.textContent = 'ë³„ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.';
                msgDiv.style.color = 'var(--color-error)';
                return;
            }

            if (!email || email.trim() === '') {
                msgDiv.textContent = 'ì´ë©”ì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.';
                msgDiv.style.color = 'var(--color-error)';
                return;
            }

            const formData = new FormData();
            formData.append('nickname', nickname.trim());
            formData.append('email', email.trim());
            if (password && password.trim() !== '') formData.append('password', password);
            formData.append('birth_date', birth_date || '');
            formData.append('gender', gender || '');

            if (imageFile) {
                formData.append('profile_image', imageFile);
            }

            document.getElementById('btnUpdateProfile').disabled = true;

            try {
                const token = localStorage.getItem('token');
                // Use fetch directly for FormData to avoid default JSON stringification
                const res = await fetch(`${API_URL}/auth/profile`, {
                    method: 'PUT',
                    headers: { 'Authorization': `Bearer ${token}` },
                    body: formData
                });

                if (res.ok) {
                    const data = await res.json();
                    localStorage.setItem('user', JSON.stringify(data.user));

                    msgDiv.textContent = 'í”„ë¡œí•„ì´ ì„±ê³µì ìœ¼ë¡œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.';
                    msgDiv.style.color = 'var(--color-success)';
                    document.getElementById('profilePassword').value = ''; // Reset password field
                    updateUIAfterLoad();

                    setTimeout(closeModals, 1500);
                } else {
                    const data = await res.json();
                    msgDiv.textContent = data.error || 'í”„ë¡œí•„ ìˆ˜ì • ì‹¤íŒ¨';
                    msgDiv.style.color = 'var(--color-error)';
                }
            } catch (e) {
                msgDiv.textContent = 'ì„œë²„ í†µì‹  ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
                msgDiv.style.color = 'var(--color-error)';
            } finally {
                document.getElementById('btnUpdateProfile').disabled = false;
            }
        }

        async function openDreamsModal() {
            closeModals();
            document.getElementById('dreamsModal').classList.remove('hidden');
            const content = document.getElementById('modalDreamsContent');

            if (allDreamsCached.length === 0) return; // Wait for initial load

            content.innerHTML = allDreamsCached.map(dream => `
                <div style="padding: 1rem; border-bottom: 1px solid var(--glass-border); display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <h4 style="margin-bottom: 0.2rem; color: var(--color-text-primary);">${dream.title}</h4>
                        <span style="font-size: 0.8rem; color: var(--color-text-muted);">${formatDate(dream.date)}</span>
                    </div>
                    <a href="/analysis-result.html?dreamId=${dream.id}" class="btn btn-outline" style="padding: 0.4rem 0.8rem; font-size: 0.85rem;">ë³´ê¸°</a>
                </div>
            `).join('');
        }

        async function openAnalysisModal() {
            closeModals();
            document.getElementById('analysisModal').classList.remove('hidden');
            const content = document.getElementById('modalAnalysisContent');
            content.innerHTML = `<div class="loading" style="height: 100px;"></div>`;

            // Filter dreams that have analysis
            const analyzedDreams = [];
            for (const dream of allDreamsCached) {
                try {
                    const analysisResponse = await authenticatedFetch(`${API_URL}/analysis/${dream.id}`);
                    if (analysisResponse.ok) {
                        analyzedDreams.push(dream);
                    }
                } catch (e) { }
            }

            if (analyzedDreams.length === 0) {
                content.innerHTML = `<p class="text-center text-muted" style="padding: 2rem;">ì•„ì§ ë¶„ì„ëœ ê¿ˆì´ ì—†ìŠµë‹ˆë‹¤.</p>`;
                return;
            }

            content.innerHTML = analyzedDreams.map(dream => `
                <div style="padding: 1rem; border-bottom: 1px solid var(--glass-border); display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <h4 style="margin-bottom: 0.2rem; color: var(--color-accent);">${dream.title}</h4>
                        <span style="font-size: 0.8rem; color: var(--color-text-muted);">${formatDate(dream.date)}</span>
                    </div>
                    <a href="/analysis-result.html?dreamId=${dream.id}" class="btn btn-primary" style="padding: 0.4rem 0.8rem; font-size: 0.85rem;">ë¶„ì„ ê²°ê³¼</a>
                </div>
            `).join('');
        }

        async function openDemographicsModal() {
            closeModals();
            document.getElementById('demoModal').classList.remove('hidden');
            const content = document.getElementById('modalDemoContent');

            try {
                const response = await authenticatedFetch(`${API_URL}/admin/stats/detailed`);
                if (response.ok) {
                    const data = await response.json();

                    const genderHtml = Object.entries(data.genderStats).filter(([k, v]) => v > 0).map(([k, v]) => `
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                            <span>${k}</span> <span style="font-weight: bold; color: var(--color-primary-light);">${v}ëª…</span>
                        </div>
                    `).join('');

                    const ageHtml = Object.entries(data.ageStats).filter(([k, v]) => v > 0).map(([k, v]) => `
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                            <span>${k}</span> <span style="font-weight: bold; color: var(--color-accent);">${v}ëª…</span>
                        </div>
                    `).join('');

                    content.innerHTML = `
                        <div style="margin-bottom: 2rem; background: var(--color-surface-light); padding: 1.5rem; border-radius: var(--radius-sm);">
                            <h3 style="margin-bottom: 1rem; color: var(--color-text-primary); border-bottom: 1px solid var(--glass-border); padding-bottom: 0.5rem;">ì„±ë³„ ë¶„í¬</h3>
                            ${genderHtml || '<p class="text-muted">ë°ì´í„° ì—†ìŒ</p>'}
                        </div>
                        <div style="background: var(--color-surface-light); padding: 1.5rem; border-radius: var(--radius-sm);">
                            <h3 style="margin-bottom: 1rem; color: var(--color-text-primary); border-bottom: 1px solid var(--glass-border); padding-bottom: 0.5rem;">ì—°ë ¹ëŒ€ ë¶„í¬</h3>
                            ${ageHtml || '<p class="text-muted">ë°ì´í„° ì—†ìŒ</p>'}
                        </div>
                    `;
                } else {
                    content.innerHTML = `<p class="text-error text-center">í†µê³„ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>`;
                }
            } catch (e) {
                content.innerHTML = `<p class="text-error text-center">ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜</p>`;
            }
        }

        // ------------------------------
        // Initial Data Loading
        // ------------------------------
        async function loadDashboardData() {
            const listElement = document.getElementById('recentDreamsList');
            showLoading('recentDreamsList');

            try {
                const response = await authenticatedFetch(`${API_URL}/dreams`);
                const data = await response.json();
                allDreamsCached = data.dreams || [];

                document.getElementById('totalDreams').textContent = allDreamsCached.length;

                if (allDreamsCached.length === 0) {
                    listElement.innerHTML = `
                        <div class="card text-center">
                            <p class="text-muted">ì•„ì§ ê¸°ë¡ëœ ê¿ˆì´ ì—†ìŠµë‹ˆë‹¤.</p>
                            <a href="/dream-input.html" class="btn btn-primary mt-md">ì²« ê¿ˆ ê¸°ë¡í•˜ê¸°</a>
                        </div>
                    `;
                } else {
                    const recentDreams = allDreamsCached.slice(0, 5);
                    listElement.innerHTML = recentDreams.map(dream => `
                        <div class="card" style="margin-bottom: 1rem; cursor: pointer;" onclick="window.location.href='/analysis-result.html?dreamId=${dream.id}'">
                            <h3 style="margin-bottom: 0.5rem;">${dream.title}</h3>
                            <p class="text-muted" style="font-size: 0.9rem; margin-bottom: 0.5rem;">${formatDate(dream.date)}</p>
                            <p style="color: var(--color-text-secondary); overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                ${dream.content.substring(0, 100)}${dream.content.length > 100 ? '...' : ''}
                            </p>
                        </div>
                    `).join('');
                }

                // Count dreams with analyses
                let analysesCount = 0;
                for (const dream of allDreamsCached) {
                    try {
                        const analysisResponse = await authenticatedFetch(`${API_URL}/analysis/${dream.id}`);
                        if (analysisResponse.ok) {
                            analysesCount++;
                        }
                    } catch (e) { }
                }
                document.getElementById('totalAnalyses').textContent = analysesCount;

                // Fetch platform users stat
                try {
                    const statsResponse = await authenticatedFetch(`${API_URL}/admin/stats`);
                    if (statsResponse.ok) {
                        const statsData = await statsResponse.json();
                        document.getElementById('totalPlatformUsers').textContent = statsData.totalUsers;
                    }
                } catch (e) {
                    console.error('Error loading platform stats', e);
                }

            } catch (error) {
                showError('recentDreamsList', 'ê¿ˆ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                console.error('Error loading dashboard:', error);
            }
        }

        // Start initialization
        loadDashboardData();
    </script>
</body>

</html>