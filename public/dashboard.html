<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ëŒ€ì‹œë³´ë“œ - ê¿ˆ ë¶„ì„ê¸°</title>
    <link rel="stylesheet" href="/styles/main.css">
</head>

<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="navbar-content">
            <a href="/dashboard.html" class="navbar-brand">ğŸŒ™ ê¿ˆ ë¶„ì„ê¸°</a>
            <ul class="navbar-nav">
                <li><a href="/dashboard.html" class="navbar-link">ëŒ€ì‹œë³´ë“œ</a></li>
                <li><a href="/dream-journal.html" class="navbar-link">ê¿ˆ ì¼ì§€</a></li>
                <li><a href="#" class="navbar-link" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</a></li>
            </ul>
        </div>
    </nav>

    <div class="container">
        <!-- Welcome Section -->
        <section class="welcome" style="margin-top: 2rem;">
            <h1 id="welcomeText">í™˜ì˜í•©ë‹ˆë‹¤</h1>
            <p class="text-muted">ë‹¹ì‹ ì˜ ë¬´ì˜ì‹ì„ íƒí—˜í•˜ê³  ê¿ˆì˜ ë©”ì‹œì§€ë¥¼ ë°œê²¬í•˜ì„¸ìš”</p>
        </section>

        <!-- Quick Actions -->
        <section class="quick-actions" style="margin-top: 2rem;">
            <a href="/dream-input.html" class="btn btn-accent" style="font-size: 1.1rem; padding: 1rem 2rem;">
                âœ¨ ìƒˆ ê¿ˆ ê¸°ë¡í•˜ê¸°
            </a>
        </section>

        <!-- Recent Dreams -->
        <section class="recent-dreams" style="margin-top: 3rem;">
            <h2 class="mb-md">ìµœê·¼ ê¿ˆ</h2>
            <div id="recentDreamsList"></div>
        </section>

        <!-- Stats -->
        <section class="stats" style="margin-top: 3rem;">
            <h2 class="mb-md">í†µê³„</h2>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem;">
                <div class="card text-center">
                    <div style="font-size: 3rem; color: var(--color-accent);">ğŸ“</div>
                    <h3 id="totalDreams">0</h3>
                    <p class="text-muted">ì´ ê¿ˆ ê¸°ë¡</p>
                </div>

                <div class="card text-center">
                    <div style="font-size: 3rem; color: var(--color-primary-light);">ğŸ”®</div>
                    <h3 id="totalAnalyses">0</h3>
                    <p class="text-muted">ë¶„ì„ ì™„ë£Œ</p>
                </div>
            </div>
        </section>
    </div>

    <script src="/js/app.js"></script>
    <script>
        // Check authentication
        if (!isAuthenticated()) {
            window.location.href = '/auth.html';
        }

        // Display user name
        const user = getUser();
        if (user) {
            document.getElementById('welcomeText').textContent = `í™˜ì˜í•©ë‹ˆë‹¤, ${user.username}ë‹˜`;
        }

        // Load recent dreams
        async function loadRecentDreams() {
            const listElement = document.getElementById('recentDreamsList');
            showLoading('recentDreamsList');

            try {
                const response = await authenticatedFetch(`${API_URL}/dreams`);
                const data = await response.json();

                if (data.dreams.length === 0) {
                    listElement.innerHTML = `
            <div class="card text-center">
              <p class="text-muted">ì•„ì§ ê¸°ë¡ëœ ê¿ˆì´ ì—†ìŠµë‹ˆë‹¤.</p>
              <a href="/dream-input.html" class="btn btn-primary mt-md">ì²« ê¿ˆ ê¸°ë¡í•˜ê¸°</a>
            </div>
          `;
                    return;
                }

                // Display recent dreams (limit to 5)
                const recentDreams = data.dreams.slice(0, 5);
                listElement.innerHTML = recentDreams.map(dream => `
          <div class="card" style="margin-bottom: 1rem; cursor: pointer;" onclick="window.location.href='/analysis-result.html?dreamId=${dream.id}'">
            <h3 style="margin-bottom: 0.5rem;">${dream.title}</h3>
            <p class="text-muted" style="font-size: 0.9rem; margin-bottom: 0.5rem;">${formatDate(dream.date)}</p>
            <p style="color: var(--color-text-secondary); overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
              ${dream.content.substring(0, 100)}${dream.content.length > 100 ? '...' : ''}
            </p>
          </div>
        `).join('');

                // Update stats
                document.getElementById('totalDreams').textContent = data.dreams.length;

                // Count dreams with analyses
                let analysesCount = 0;
                for (const dream of data.dreams) {
                    try {
                        const analysisResponse = await authenticatedFetch(`${API_URL}/analysis/${dream.id}`);
                        if (analysisResponse.ok) {
                            analysesCount++;
                        }
                    } catch (e) {
                        // No analysis for this dream
                    }
                }
                document.getElementById('totalAnalyses').textContent = analysesCount;

            } catch (error) {
                showError('recentDreamsList', 'ê¿ˆ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                console.error('Error loading dreams:', error);
            }
        }

        // Load data on page load
        loadRecentDreams();
    </script>
</body>

</html>