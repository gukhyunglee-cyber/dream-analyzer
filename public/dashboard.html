<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ëŒ€ì‹œë³´ë“œ - ê¿ˆ ì—¬í–‰</title>
    <link rel="stylesheet" href="/styles/main.css">
    <link rel="manifest" href="/manifest.json">
        </head>

<body>
    <nav class="navbar">
        <div class="navbar-content">
            <a href="/index.html" class="navbar-brand">ğŸŒ™ ê¿ˆ ì—¬í–‰</a>
            <ul class="navbar-nav" style="align-items: center;">
                <li><a href="/community.html" class="navbar-link">ê²Œì‹œíŒ</a></li>
                <li><a href="/dream-journal.html" class="navbar-link">ê¿ˆ ì¼ì§€</a></li>
                <li><a href="/dashboard.html" class="navbar-link active">ëŒ€ì‹œë³´ë“œ</a></li>
                <li id="nav-auth-section"></li>
            </ul>
        </div>
    </nav>

    <div class="container">
        <!-- Dashboard Top Fold: Welcome & Stats -->
        <div
            style="display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; margin-top: 2rem; gap: 2rem;">
            <!-- Welcome Section -->
            <section class="welcome" style="flex: 1; min-width: 300px;">
                <h1 id="welcomeText" style="font-size: 2.5rem; margin-bottom: 0.5rem;">í™˜ì˜í•©ë‹ˆë‹¤</h1>
                <p class="text-muted">ë‹¹ì‹ ì˜ ë¬´ì˜ì‹ì„ íƒí—˜í•˜ê³  ê¿ˆì˜ ë©”ì‹œì§€ë¥¼ ë°œê²¬í•˜ì„¸ìš”</p>
                <div class="mt-md">
                    <a href="/dream-input.html" class="btn btn-accent"
                        style="font-size: 1.1rem; padding: 0.8rem 1.5rem;">
                        âœ¨ ìƒˆ ê¿ˆ ê¸°ë¡í•˜ê¸°
                    </a>
                </div>
            </section>

            <!-- Stats Section -->
            <section class="stats" style="display: flex; gap: 1rem; flex-wrap: wrap;">
                <div class="card text-center" style="padding: 1rem; cursor: pointer; min-width: 130px;"
                    onclick="openDreamsModal()">
                    <div style="font-size: 1.8rem; color: var(--color-accent);">ğŸ“</div>
                    <h3 id="totalDreams" style="font-size: 1.5rem; margin: 0.5rem 0;">0</h3>
                    <p class="text-muted" style="font-size: 0.85rem; margin: 0;">ì´ ê¿ˆ ê¸°ë¡(í†µê³„ë³´ê¸°)</p>
                </div>
                <div class="card text-center" style="padding: 1rem; cursor: pointer; min-width: 130px;"
                    onclick="openAnalysisModal()">
                    <div style="font-size: 1.8rem; color: var(--color-primary-light);">ğŸ”®</div>
                    <h3 id="totalAnalyses" style="font-size: 1.5rem; margin: 0.5rem 0;">0</h3>
                    <p class="text-muted" style="font-size: 0.85rem; margin: 0;">ë¶„ì„ ì™„ë£Œ(í†µê³„ë³´ê¸°)</p>
                </div>
                <div class="card text-center"
                    style="padding: 1rem; cursor: pointer; min-width: 130px; background: rgba(139, 92, 246, 0.05);"
                    onclick="openDemographicsModal()">
                    <div style="font-size: 1.8rem; color: var(--color-secondary);">ğŸ‘¥</div>
                    <h3 id="totalPlatformUsers" style="font-size: 1.5rem; margin: 0.5rem 0;">0</h3>
                    <p class="text-muted" style="font-size: 0.85rem; margin: 0;">ì „ì²´ ê°€ì…ì(ìƒì„¸í†µê³„)</p>
                </div>
            </section>
        </div>

        <!-- Recent Dreams -->
        <section class="recent-dreams" style="margin-top: 3rem;">
            <h2 class="mb-md">ìµœê·¼ ê¿ˆ</h2>
            <div id="recentDreamsList"></div>
        </section>
    </div>

    <!-- Modals -->

    <!-- User Dreams List Modal -->
    <div id="dreamsModal" class="modal hidden">
        <div class="modal-content" style="max-width: 600px;">
            <button class="modal-close" onclick="closeModals()">&times;</button>
            <h2 class="mb-md" style="color: var(--color-accent);">ğŸ“ ë‚´ê°€ ê¸°ë¡í•œ ê¿ˆ ëª©ë¡</h2>
            <div id="modalDreamsContent" style="max-height: 50vh; overflow-y: auto;">
                <div class="loading" style="height: 100px;"></div>
            </div>
        </div>
    </div>

    <!-- User Analyzed Dreams Modal -->
    <div id="analysisModal" class="modal hidden">
        <div class="modal-content" style="max-width: 600px;">
            <button class="modal-close" onclick="closeModals()">&times;</button>
            <h2 class="mb-md" style="color: var(--color-primary-light);">ğŸ”® ë¶„ì„ ì™„ë£Œëœ ê¿ˆ ëª©ë¡</h2>
            <div id="modalAnalysisContent" style="max-height: 50vh; overflow-y: auto;">
                <div class="loading" style="height: 100px;"></div>
            </div>
        </div>
    </div>

    <!-- Demographics Modal -->
    <div id="demoModal" class="modal hidden">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModals()">&times;</button>
            <h2 class="mb-md" style="color: var(--color-secondary);">ğŸ‘¥ ì „ì²´ ìœ ì € í†µê³„</h2>
            <div id="modalDemoContent">
                <div class="loading" style="height: 200px;"></div>
            </div>
        </div>
    </div>

    <script src="/js/app.js"></script>
    <script>
        // Check authentication
        if (!isAuthenticated()) {
            window.location.href = '/auth.html';
        }

        let allDreamsCached = []; // Cache to avoid refetching

        // Display user name and profile
        function updateUIAfterLoad() {
            const user = getUser();
            if (user) {
                document.getElementById('welcomeText').textContent = `í™˜ì˜í•©ë‹ˆë‹¤, ${user.nickname || user.username}ë‹˜`;
            }
        }
        updateUIAfterLoad();

        // ------------------------------
        // Modals Logic
        // ------------------------------
        function closeModals() {
            document.querySelectorAll('.modal').forEach(m => m.classList.add('hidden'));
        }

        async function openDreamsModal() {
            closeModals();
            document.getElementById('dreamsModal').classList.remove('hidden');
            const content = document.getElementById('modalDreamsContent');

            if (allDreamsCached.length === 0) return; // Wait for initial load

            content.innerHTML = allDreamsCached.map(dream => `
                <div style="padding: 1rem; border-bottom: 1px solid var(--glass-border); display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <h4 style="margin-bottom: 0.2rem; color: var(--color-text-primary);">${dream.title}</h4>
                        <span style="font-size: 0.8rem; color: var(--color-text-muted);">${formatDate(dream.date)}</span>
                    </div>
                    <a href="/analysis-result.html?dreamId=${dream.id}" class="btn btn-outline" style="padding: 0.4rem 0.8rem; font-size: 0.85rem;">ë³´ê¸°</a>
                </div>
            `).join('');
        }

        async function openAnalysisModal() {
            closeModals();
            document.getElementById('analysisModal').classList.remove('hidden');
            const content = document.getElementById('modalAnalysisContent');
            content.innerHTML = `<div class="loading" style="height: 100px;"></div>`;

            // Filter dreams that have analysis
            const analyzedDreams = [];
            for (const dream of allDreamsCached) {
                try {
                    const analysisResponse = await authenticatedFetch(`${API_URL}/analysis/${dream.id}`);
                    if (analysisResponse.ok) {
                        analyzedDreams.push(dream);
                    }
                } catch (e) { }
            }

            if (analyzedDreams.length === 0) {
                content.innerHTML = `<p class="text-center text-muted" style="padding: 2rem;">ì•„ì§ ë¶„ì„ëœ ê¿ˆì´ ì—†ìŠµë‹ˆë‹¤.</p>`;
                return;
            }

            content.innerHTML = analyzedDreams.map(dream => `
                <div style="padding: 1rem; border-bottom: 1px solid var(--glass-border); display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <h4 style="margin-bottom: 0.2rem; color: var(--color-accent);">${dream.title}</h4>
                        <span style="font-size: 0.8rem; color: var(--color-text-muted);">${formatDate(dream.date)}</span>
                    </div>
                    <a href="/analysis-result.html?dreamId=${dream.id}" class="btn btn-primary" style="padding: 0.4rem 0.8rem; font-size: 0.85rem;">ë¶„ì„ ê²°ê³¼</a>
                </div>
            `).join('');
        }

        async function openDemographicsModal() {
            closeModals();
            document.getElementById('demoModal').classList.remove('hidden');
            const content = document.getElementById('modalDemoContent');

            try {
                const response = await authenticatedFetch(`${API_URL}/admin/stats/detailed`);
                if (response.ok) {
                    const data = await response.json();

                    const genderHtml = Object.entries(data.genderStats).filter(([k, v]) => v > 0).map(([k, v]) => `
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                            <span>${k}</span> <span style="font-weight: bold; color: var(--color-primary-light);">${v}ëª…</span>
                        </div>
                    `).join('');

                    const ageHtml = Object.entries(data.ageStats).filter(([k, v]) => v > 0).map(([k, v]) => `
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                            <span>${k}</span> <span style="font-weight: bold; color: var(--color-accent);">${v}ëª…</span>
                        </div>
                    `).join('');

                    content.innerHTML = `
                        <div style="margin-bottom: 2rem; background: var(--color-surface-light); padding: 1.5rem; border-radius: var(--radius-sm);">
                            <h3 style="margin-bottom: 1rem; color: var(--color-text-primary); border-bottom: 1px solid var(--glass-border); padding-bottom: 0.5rem;">ì„±ë³„ ë¶„í¬</h3>
                            ${genderHtml || '<p class="text-muted">ë°ì´í„° ì—†ìŒ</p>'}
                        </div>
                        <div style="background: var(--color-surface-light); padding: 1.5rem; border-radius: var(--radius-sm);">
                            <h3 style="margin-bottom: 1rem; color: var(--color-text-primary); border-bottom: 1px solid var(--glass-border); padding-bottom: 0.5rem;">ì—°ë ¹ëŒ€ ë¶„í¬</h3>
                            ${ageHtml || '<p class="text-muted">ë°ì´í„° ì—†ìŒ</p>'}
                        </div>
                    `;
                } else {
                    content.innerHTML = `<p class="text-error text-center">í†µê³„ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>`;
                }
            } catch (e) {
                content.innerHTML = `<p class="text-error text-center">ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜</p>`;
            }
        }

        // ------------------------------
        // Initial Data Loading
        // ------------------------------
        async function loadDashboardData() {
            const listElement = document.getElementById('recentDreamsList');
            showLoading('recentDreamsList');

            try {
                const response = await authenticatedFetch(`${API_URL}/dreams`);
                const data = await response.json();
                allDreamsCached = data.dreams || [];

                document.getElementById('totalDreams').textContent = allDreamsCached.length;

                if (allDreamsCached.length === 0) {
                    listElement.innerHTML = `
                        <div class="card text-center">
                            <p class="text-muted">ì•„ì§ ê¸°ë¡ëœ ê¿ˆì´ ì—†ìŠµë‹ˆë‹¤.</p>
                            <a href="/dream-input.html" class="btn btn-primary mt-md">ì²« ê¿ˆ ê¸°ë¡í•˜ê¸°</a>
                        </div>
                    `;
                } else {
                    const recentDreams = allDreamsCached.slice(0, 5);
                    listElement.innerHTML = recentDreams.map(dream => `
                        <div class="card" style="margin-bottom: 1rem; cursor: pointer;" onclick="window.location.href='/analysis-result.html?dreamId=${dream.id}'">
                            <h3 style="margin-bottom: 0.5rem;">${dream.title}</h3>
                            <p class="text-muted" style="font-size: 0.9rem; margin-bottom: 0.5rem;">${formatDate(dream.date)}</p>
                            <p style="color: var(--color-text-secondary); overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                ${dream.content.substring(0, 100)}${dream.content.length > 100 ? '...' : ''}
                            </p>
                        </div>
                    `).join('');
                }

                // Count dreams with analyses
                let analysesCount = 0;
                for (const dream of allDreamsCached) {
                    try {
                        const analysisResponse = await authenticatedFetch(`${API_URL}/analysis/${dream.id}`);
                        if (analysisResponse.ok) {
                            analysesCount++;
                        }
                    } catch (e) { }
                }
                document.getElementById('totalAnalyses').textContent = analysesCount;

                // Fetch platform users stat
                try {
                    const statsResponse = await authenticatedFetch(`${API_URL}/admin/stats`);
                    if (statsResponse.ok) {
                        const statsData = await statsResponse.json();
                        document.getElementById('totalPlatformUsers').textContent = statsData.totalUsers;
                    }
                } catch (e) {
                    console.error('Error loading platform stats', e);
                }

            } catch (error) {
                showError('recentDreamsList', 'ê¿ˆ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                console.error('Error loading dashboard:', error);
            }
        }

        // Start initialization
        loadDashboardData();
    </script>


    <!-- Global Footer -->
    <footer style="margin-top: 4rem; padding: 2rem; border-top: 1px solid var(--glass-border); text-align: center; color: var(--color-text-muted); background: var(--color-surface);">
        <div style="display: flex; justify-content: center; gap: 1.5rem; margin-bottom: 1rem; flex-wrap: wrap;">
            <a href="/about.html" style="color: var(--color-text-secondary); text-decoration: none;">ì„œë¹„ìŠ¤ ì†Œê°œ</a>
            <a href="/contact.html" style="color: var(--color-text-secondary); text-decoration: none;">ë¬¸ì˜í•˜ê¸°</a>
            <a href="/terms.html" style="color: var(--color-text-secondary); text-decoration: none;">ì´ìš©ì•½ê´€</a>
            <a href="/privacy.html" style="color: var(--color-text-secondary); text-decoration: none;">ê°œì¸ì •ë³´ì²˜ë¦¬ë°©ì¹¨</a>
        </div>
        <p style="font-size: 0.9rem;">&copy; 2026 ê¿ˆ ì—¬í–‰. ì¹¼ ìœµì˜ ë¶„ì„ì‹¬ë¦¬í•™ì„ ê¸°ë°˜ìœ¼ë¡œ í•©ë‹ˆë‹¤.</p>
    </footer>
</body>

</html>