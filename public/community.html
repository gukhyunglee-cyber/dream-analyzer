<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê²Œì‹œíŒ - ê¿ˆ ì—¬í–‰</title>
    <link rel="stylesheet" href="/styles/main.css">
    <style>
        .comment-section {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--glass-border);
            display: none;
        }

        .comment-item {
            background: var(--glass-bg);
            padding: 0.75rem;
            border-radius: var(--radius-sm);
            margin-bottom: 0.5rem;
        }

        .comment-item p {
            margin: 0;
            font-size: 0.9rem;
        }

        .comment-meta {
            font-size: 0.75rem;
            color: var(--color-text-secondary);
            margin-bottom: 0.25rem;
            display: flex;
            justify-content: space-between;
        }

        .btn-toggle-comments {
            background: none;
            border: none;
            color: var(--color-accent);
            cursor: pointer;
            padding: 0;
            font-size: 0.9rem;
            text-decoration: underline;
        }
    </style>
    <link rel="manifest" href="/manifest.json">
</head>

<body>
    <nav class="navbar">
        <div class="navbar-content">
            <a href="/index.html" class="navbar-brand">ğŸŒ™ ê¿ˆ ì—¬í–‰</a>
            <ul class="navbar-nav">
                <li><a href="/community.html" class="navbar-link active">ê²Œì‹œíŒ</a></li>
                <li><a href="/dream-journal.html" class="navbar-link">ê¿ˆ ì¼ì§€</a></li>
                <li><a href="/dashboard.html" class="navbar-link">ëŒ€ì‹œë³´ë“œ</a></li>
                <li id="nav-auth-section">
                    <!-- Auth content injected via JS -->
                </li>
            </ul>
        </div>
    </nav>

    <div class="container" style="margin-top: 2rem;">
        <div class="tabs"
            style="display: flex; gap: 2rem; border-bottom: 1px solid var(--glass-border); margin-bottom: 2rem; padding-bottom: 0.5rem;">
            <button id="tabBulletinBoard"
                style="background: none; border: none; font-size: 1.2rem; font-weight: bold; color: var(--color-accent); cursor: pointer; border-bottom: 2px solid var(--color-accent); padding-bottom: 0.5rem;"
                onclick="switchTab('bulletinBoard')">ğŸ“‹ ê³µì§€ì‚¬í•­</button>
            <button id="tabDreamShare"
                style="background: none; border: none; font-size: 1.2rem; font-weight: bold; color: var(--color-text-muted); cursor: pointer; padding-bottom: 0.5rem;"
                onclick="switchTab('dreamShare')">ğŸ’­ ê¿ˆê³µìœ </button>
        </div>

        <div id="dreamShareSection" style="display: none;">
            <div class="d-flex" style="justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                <p class="text-muted">ë‹¤ë¥¸ ì‚¬ëŒë“¤ê³¼ ì‹ ë¹„ë¡œìš´ ê¿ˆ ê¸°ë¡ì„ ë‚˜ëˆ„ê³  ê³µê°í•´ë³´ì„¸ìš”.</p>
            </div>

            <div id="loading" class="text-center" style="display: none; padding: 2rem;">
                <div class="loading"></div>
                <p class="mt-md text-muted">ê¿ˆ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
            </div>

            <div id="communityList" style="display: grid; gap: 1.5rem;">
                <!-- Public dreams injected here -->
            </div>
        </div>

        <div id="bulletinBoardSection">
            <div class="d-flex" style="justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                <p class="text-muted">ììœ ë¡­ê²Œ ì†Œì‹ì„ ë‚˜ëˆ„ê³  ê³µìœ í•˜ëŠ” ê³µê°„ì…ë‹ˆë‹¤.</p>
                <button class="btn btn-primary" id="btnOpenNoticeModal" style="display: none;"
                    onclick="openNoticeModal()">ê¸€ ì‘ì„±í•˜ê¸°</button>
            </div>

            <div id="noticeRequiredAuth" class="text-center p-md mb-lg"
                style="background: var(--glass-bg); border-radius: var(--radius-md);">
                <p class="text-muted m-0">ê¸€ì„ ì‘ì„±í•˜ë ¤ë©´ <a href="/auth.html" style="color: var(--color-accent);">ë¡œê·¸ì¸</a>ì´
                    í•„ìš”í•©ë‹ˆë‹¤.</p>
            </div>

            <div id="noticeLoading" class="text-center" style="display: none; padding: 2rem;">
                <div class="loading"></div>
                <p class="mt-md text-muted">ê²Œì‹œê¸€ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
            </div>

            <div id="noticeList" style="display: grid; gap: 1.5rem;">
                <!-- Posts injected here -->
            </div>
        </div>
    </div>

    <!-- Global Footer -->
    <footer
        style="margin-top: 4rem; padding: 2rem; border-top: 1px solid var(--glass-border); text-align: center; color: var(--color-text-muted);">
        <div style="display: flex; justify-content: center; gap: 1.5rem; margin-bottom: 1rem; flex-wrap: wrap;">
            <a href="/about.html" style="color: var(--color-text-secondary); text-decoration: none;">ì„œë¹„ìŠ¤ ì†Œê°œ</a>
            <a href="/terms.html" style="color: var(--color-text-secondary); text-decoration: none;">ì´ìš©ì•½ê´€</a>
            <a href="/privacy.html" style="color: var(--color-text-secondary); text-decoration: none;">ê°œì¸ì •ë³´ ì²˜ë¦¬ë°©ì¹¨</a>
        </div>
        <p style="font-size: 0.9rem;">&copy; 2024 Dream Analyzer. All rights reserved.</p>
    </footer>

    <div id="noticePostModal" class="modal hidden">
        <div class="modal-content">
            <button class="modal-close" onclick="closeNoticeModal()">&times;</button>
            <h2 class="mb-md text-center">ê³µì§€ì‚¬í•­ ê¸€ ë“±ë¡</h2>
            <form id="noticePostForm" onsubmit="submitNoticePost(event)">
                <div class="form-group mb-sm">
                    <label class="form-label" for="noticeTitle">ì œëª©</label>
                    <input type="text" id="noticeTitle" class="form-input" placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”" required>
                </div>
                <div class="form-group mb-sm">
                    <label class="form-label" for="noticeContent">ë‚´ìš©</label>
                    <textarea id="noticeContent" class="form-textarea" placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”..." required
                        style="min-height: 150px;"></textarea>
                </div>
                <p id="noticePostMsg" class="text-center mt-sm" style="font-size: 0.9rem; margin-bottom: 1rem;"></p>
                <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                    <button type="button" class="btn btn-outline" onclick="closeNoticeModal()">ì·¨ì†Œ</button>
                    <button type="submit" class="btn btn-primary" id="btnSubmitNotice">ê¸€ ë“±ë¡</button>
                </div>
            </form>
        </div>
    </div>

    <script src="/js/app.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            switchTab('bulletinBoard');
        });

        function switchTab(tabId) {
            const btnDreamShare = document.getElementById('tabDreamShare');
            const btnBulletin = document.getElementById('tabBulletinBoard');
            const secDreamShare = document.getElementById('dreamShareSection');
            const secBulletin = document.getElementById('bulletinBoardSection');

            if (tabId === 'dreamShare') {
                btnDreamShare.style.color = 'var(--color-accent)';
                btnDreamShare.style.borderBottom = '2px solid var(--color-accent)';
                btnBulletin.style.color = 'var(--color-text-muted)';
                btnBulletin.style.borderBottom = 'none';

                secDreamShare.style.display = 'block';
                secBulletin.style.display = 'none';

                if (!window.dreamShareLoaded) {
                    loadCommunityDreams();
                    window.dreamShareLoaded = true;
                }
            } else {
                btnBulletin.style.color = 'var(--color-accent)';
                btnBulletin.style.borderBottom = '2px solid var(--color-accent)';
                btnDreamShare.style.color = 'var(--color-text-muted)';
                btnDreamShare.style.borderBottom = 'none';

                secBulletin.style.display = 'block';
                secDreamShare.style.display = 'none';

                if (!window.noticeLoaded) {
                    loadNoticeBoard();
                    window.noticeLoaded = true;
                }

                const btnWrite = document.getElementById('btnOpenNoticeModal');
                const authReq = document.getElementById('noticeRequiredAuth');
                if (isAuthenticated()) {
                    if (btnWrite) btnWrite.style.display = 'block';
                    if (authReq) authReq.style.display = 'none';
                } else {
                    if (btnWrite) btnWrite.style.display = 'none';
                    if (authReq) authReq.style.display = 'block';
                }
            }
        }

        function openNoticeModal() {
            document.getElementById('noticeTitle').value = '';
            document.getElementById('noticeContent').value = '';
            document.getElementById('noticePostMsg').textContent = '';
            delete document.getElementById('noticePostForm').dataset.editingId;
            document.getElementById('noticePostModal').classList.remove('hidden');
        }

        function closeNoticeModal() {
            document.getElementById('noticePostModal').classList.add('hidden');
        }

        async function loadCommunityDreams() {
            showLoading('communityList');
            try {
                const fetchFunc = isAuthenticated() ? authenticatedFetch : fetch;
                const headers = isAuthenticated() ? {
                    'Authorization': `Bearer ${localStorage.getItem('dream_token')}`
                } : {};

                const response = await fetchFunc(`${API_URL}/community`, { headers });
                const data = await response.json();

                if (!response.ok) throw new Error(data.error || 'Failed to load community dreams');

                const communityList = document.getElementById('communityList');
                communityList.innerHTML = '';

                if (data.dreams.length === 0) {
                    communityList.innerHTML = `
                        <div class="card text-center" style="padding: 3rem;">
                            <h3>ğŸ“­ ì•„ì§ ê³µìœ ëœ ê¿ˆì´ ì—†ìŠµë‹ˆë‹¤.</h3>
                            <p class="text-muted">ê¿ˆ ì¼ì§€ì—ì„œ ë‚´ ê¿ˆì„ ê³µê°œë¡œ ì„¤ì •í•˜ì—¬ ì²« ê³µìœ ìê°€ ë˜ì–´ë³´ì„¸ìš”!</p>
                        </div>
                    `;
                    return;
                }

                data.dreams.forEach((dream, index) => {
                    const delay = index * 0.1;
                    const card = document.createElement('div');
                    card.className = 'card fade-in';
                    card.style.animationDelay = `${delay}s`;

                    let emotionsHtml = '';
                    if (dream.emotions && dream.emotions.length > 0) {
                        emotionsHtml = `<div style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-bottom: 1rem;">
                            ${dream.emotions.map(e => `<span style="background: var(--color-primary-light); padding: 0.2rem 0.6rem; border-radius: 1rem; font-size: 0.8rem;">${e}</span>`).join('')}
                        </div>`;
                    }

                    // Mask exact date, show relative
                    const dreamDate = new Date(dream.date).toLocaleDateString();

                    // Map reaction counts safely
                    const r = dream.reactions || {};
                    const rLikes = r['ğŸ‘'] || 0;
                    const rHearts = r['â¤ï¸'] || 0;
                    const rSmiles = r['ğŸ˜Š'] || 0;
                    const rCrys = r['ğŸ˜¢'] || 0;
                    const rWows = r['ğŸ˜®'] || 0;

                    const authorAvatarHtml = dream.profile_image_url
                        ? `<img src="${dream.profile_image_url}" alt="avatar" style="width: 24px; height: 24px; border-radius: 50%; object-fit: cover; vertical-align: middle; margin-right: 5px;">`
                        : 'ğŸ‘¤ ';

                    const currentUser = getUser();
                    const isOwner = currentUser && currentUser.id === dream.user_id;
                    const isAdmin = currentUser && currentUser.is_admin;

                    let adminDeleteHtml = '';
                    if (isAdmin || isOwner) {
                        adminDeleteHtml = `<button class="btn btn-outline btn-sm" style="color: var(--color-error); border-color: var(--color-error); padding: 0.1rem 0.4rem; font-size: 0.75rem; margin-left: 0.5rem;" onclick="deleteDream(${dream.id})">ì‚­ì œ</button>`;
                    }

                    card.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem;">
                            <h3 style="margin: 0; color: var(--color-accent);">${dream.title} ${adminDeleteHtml}</h3>
                            <span class="text-muted" style="font-size: 0.85rem;">${dreamDate} â€¢ ${authorAvatarHtml}${dream.display_name}</span>
                        </div>
                        ${emotionsHtml}
                        <p style="color: var(--color-text); line-height: 1.6; margin-bottom: 1rem;">${dream.content}</p>
                        ${dream.overall_interpretation ? `
                        <div style="text-align: right; margin-bottom: 0.5rem;">
                            <button class="btn btn-outline btn-sm" onclick="toggleInterpretation(${dream.id}, this)" style="padding: 0.3rem 0.6rem; font-size: 0.8rem;">âœ¨ ì „ì²´í•´ì„ ë³´ê¸°</button>
                        </div>
                        <div id="interpretation-${dream.id}" style="display: none; background: var(--color-surface); padding: 1rem; border-radius: var(--radius-sm); border-left: 3px solid var(--color-accent); margin-bottom: 1rem;">
                            <h4 style="color: var(--color-accent); margin-bottom: 0.5rem; font-size: 0.95rem;">âœ¨ ì „ì²´ í•´ì„</h4>
                            <p style="font-size: 0.9rem; color: var(--color-text); margin: 0; line-height: 1.6; white-space: pre-wrap;">${dream.overall_interpretation}</p>
                        </div>
                        ` : ''}
                        
                        <!-- Reaction Bar -->
                        <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
                            <button class="btn btn-outline" style="padding: 0.3rem 0.6rem; font-size: 0.85rem;" onclick="toggleReaction('dream', ${dream.id}, 'ğŸ‘')">ğŸ‘ ${rLikes}</button>
                            <button class="btn btn-outline" style="padding: 0.3rem 0.6rem; font-size: 0.85rem;" onclick="toggleReaction('dream', ${dream.id}, 'â¤ï¸')">â¤ï¸ ${rHearts}</button>
                            <button class="btn btn-outline" style="padding: 0.3rem 0.6rem; font-size: 0.85rem;" onclick="toggleReaction('dream', ${dream.id}, 'ğŸ˜Š')">ğŸ˜Š ${rSmiles}</button>
                            <button class="btn btn-outline" style="padding: 0.3rem 0.6rem; font-size: 0.85rem;" onclick="toggleReaction('dream', ${dream.id}, 'ğŸ˜¢')">ğŸ˜¢ ${rCrys}</button>
                            <button class="btn btn-outline" style="padding: 0.3rem 0.6rem; font-size: 0.85rem;" onclick="toggleReaction('dream', ${dream.id}, 'ğŸ˜®')">ğŸ˜® ${rWows}</button>
                        </div>

                        <div style="text-align: right;">
                            <button class="btn-toggle-comments" onclick="toggleComments(${dream.id}, this)">
                                ğŸ’¬ ëŒ“ê¸€ ë³´ê¸°
                            </button>
                        </div>

                        <div id="comments-${dream.id}" class="comment-section">
                            <!-- Comments loaded here -->
                            <div class="comments-list" style="margin-bottom: 1rem;"></div>
                            
                            <!-- Comment Form (only if logged in) -->
                            ${isAuthenticated() ? `
                                <div style="display: flex; gap: 0.5rem;">
                                    <input type="text" id="comment-input-${dream.id}" class="form-control" placeholder="ë”°ëœ»í•œ ìœ„ë¡œì™€ ê³µê°ì˜ ëŒ“ê¸€ì„ ë‚¨ê²¨ë³´ì„¸ìš”." style="flex: 1; margin-bottom: 0;">
                                    <button onclick="submitComment(${dream.id})" class="btn btn-primary" style="padding: 0.5rem 1rem;">ì‘ì„±</button>
                                </div>
                            ` : `
                                <div class="text-center p-sm" style="background: var(--glass-bg); border-radius: var(--radius-sm);">
                                    <p class="text-muted m-0" style="font-size: 0.85rem;">ëŒ“ê¸€ì„ ë‚¨ê¸°ë ¤ë©´ <a href="/auth.html" style="color: var(--color-accent);">ë¡œê·¸ì¸</a>ì´ í•„ìš”í•©ë‹ˆë‹¤.</p>
                                </div>
                            `}
                        </div>
                    `;
                    communityList.appendChild(card);
                });

            } catch (error) {
                showError('communityList', 'ì»¤ë®¤ë‹ˆí‹° ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                console.error(error);
            }
        }

        async function toggleComments(dreamId, btnElement) {
            const commentSection = document.getElementById(`comments-${dreamId}`);

            if (commentSection.style.display === 'block') {
                commentSection.style.display = 'none';
                btnElement.textContent = 'ğŸ’¬ ëŒ“ê¸€ ë³´ê¸°';
                return;
            }

            // Expand
            commentSection.style.display = 'block';
            btnElement.textContent = 'ìˆ¨ê¸°ê¸°';

            // Fetch comments
            await loadComments(dreamId);
        }

        function toggleInterpretation(dreamId, btnElement) {
            const interpretSection = document.getElementById(`interpretation-${dreamId}`);
            if (interpretSection.style.display === 'block') {
                interpretSection.style.display = 'none';
                btnElement.textContent = 'âœ¨ ì „ì²´í•´ì„ ë³´ê¸°';
            } else {
                interpretSection.style.display = 'block';
                btnElement.textContent = 'ìˆ¨ê¸°ê¸°';
            }
        }

        async function toggleReaction(targetType, targetId, emoji) {
            if (!isAuthenticated()) {
                alert('ë¡œê·¸ì¸ì´ í•„ìš”í•œ ê¸°ëŠ¥ì…ë‹ˆë‹¤.');
                return window.location.href = '/auth.html';
            }
            try {
                const res = await authenticatedFetch(`${API_URL}/community/react`, {
                    method: 'POST',
                    body: JSON.stringify({ target_type: targetType, target_id: targetId, emoji })
                });

                if (res.ok) {
                    // Re-render comments if it's a comment, or the whole list if it's a dream
                    if (targetType === 'dream') {
                        loadCommunityDreams();
                    } else {
                        // We need the parent dream ID to reload comments.
                        // For simplicity, we can just trigger a general reload or store the mapping.
                        // Finding the closest comment section block:
                        const section = document.querySelector(`#reply-box-${targetId}`)?.closest('.comment-section');
                        if (section) {
                            const dreamId = section.id.replace('comments-', '');
                            loadComments(dreamId);
                        } else {
                            loadCommunityDreams(); // Fallback
                        }
                    }
                } else {
                    const data = await res.json();
                    alert(data.error || 'ë°˜ì‘ ì²˜ë¦¬ ì‹¤íŒ¨');
                }
            } catch (e) {
                alert('ë°˜ì‘ì„ ì €ì¥í•˜ëŠ” ì¤‘ì— ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        function organizeCommentsTree(comments) {
            const map = {};
            const roots = [];
            comments.forEach(c => {
                map[c.id] = { ...c, children: [] };
            });
            comments.forEach(c => {
                if (c.parent_id && map[c.parent_id]) {
                    map[c.parent_id].children.push(map[c.id]);
                } else {
                    roots.push(map[c.id]);
                }
            });
            return roots;
        }

        function renderCommentHtml(c, dreamId, isReply = false) {
            const date = new Date(c.created_at).toLocaleString();
            const r = c.reactions || {};
            const depthStyle = isReply ? "margin-left: 2rem; border-left: 2px solid var(--color-accent); padding-left: 1rem;" : "";

            const authorAvatarHtml = c.profile_image_url
                ? `<img src="${c.profile_image_url}" alt="avatar" style="width: 20px; height: 20px; border-radius: 50%; object-fit: cover; vertical-align: middle; margin-right: 5px;">`
                : 'ğŸ‘¤ ';

            const currentUser = getUser();
            const isOwner = currentUser && currentUser.id === c.user_id;
            const isAdmin = currentUser && currentUser.is_admin;
            let editDeleteHtml = '';

            if (isOwner) {
                editDeleteHtml = `
                <button class="btn btn-outline" style="padding: 0.1rem 0.4rem; font-size: 0.75rem;" onclick="editComment(${dreamId}, ${c.id}, this)">ìˆ˜ì •</button>
                <button class="btn btn-outline" style="padding: 0.1rem 0.4rem; font-size: 0.75rem; color: var(--color-error); border-color: var(--color-error);" onclick="deleteComment(${dreamId}, ${c.id})">ì‚­ì œ</button>
                `;
            } else if (isAdmin) {
                editDeleteHtml = `
                <button class="btn btn-outline" style="padding: 0.1rem 0.4rem; font-size: 0.75rem; color: var(--color-error); border-color: var(--color-error);" onclick="deleteComment(${dreamId}, ${c.id})">ì‚­ì œ</button>
                `;
            }

            let html = `
                <div class="comment-item" style="${depthStyle}">
                    <div class="comment-meta">
                        <strong>${authorAvatarHtml}${c.display_name}</strong>
                        <span>${date}</span>
                    </div>
                    <p id="comment-text-${c.id}" style="margin-bottom: 0.5rem; white-space: pre-wrap;">${c.content}</p>
                    
                    <div style="display: flex; gap: 0.5rem; align-items: center; margin-bottom: 0.5rem;">
                        <button class="btn btn-outline" style="padding: 0.1rem 0.4rem; font-size: 0.75rem;" onclick="toggleReaction('comment', ${c.id}, 'ğŸ‘')">ğŸ‘ ${r['ğŸ‘'] || 0}</button>
                        <button class="btn btn-outline" style="padding: 0.1rem 0.4rem; font-size: 0.75rem;" onclick="toggleReaction('comment', ${c.id}, 'â¤ï¸')">â¤ï¸ ${r['â¤ï¸'] || 0}</button>
                        <button class="btn-toggle-comments" style="font-size: 0.8rem; margin-left: 0.5rem;" onclick="const rb = document.getElementById('reply-box-${c.id}'); rb.style.display = (rb.style.display === 'none' || !rb.style.display) ? 'flex' : 'none';">â†©ï¸ ë‹µê¸€ë‹¬ê¸°</button>
                        ${editDeleteHtml}
                    </div>

                    <div id="reply-box-${c.id}" style="display: none; gap: 0.5rem; margin-top: 0.5rem;">
                        <input type="text" id="reply-input-${c.id}" class="form-control" placeholder="ë‹µê¸€ì„ ì…ë ¥í•˜ì„¸ìš”..." style="flex: 1; margin-bottom: 0; padding: 0.3rem 0.6rem; font-size: 0.85rem;">
                        <button onclick="submitComment(${dreamId}, ${c.id})" class="btn btn-primary" style="padding: 0.3rem 0.8rem; font-size: 0.85rem;">ì‘ì„±</button>
                    </div>
                </div>
            `;

            if (c.children && c.children.length > 0) {
                c.children.forEach(child => {
                    html += renderCommentHtml(child, dreamId, true);
                });
            }

            return html;
        }

        async function loadComments(dreamId) {
            const listContainer = document.querySelector(`#comments-${dreamId} .comments-list`);
            listContainer.innerHTML = '<p class="text-muted" style="font-size:0.8rem;">ëŒ“ê¸€ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>';

            try {
                const res = await fetch(`${API_URL}/community/${dreamId}/comments`);
                const data = await res.json();

                listContainer.innerHTML = '';

                if (data.comments.length === 0) {
                    listContainer.innerHTML = '<p class="text-muted" style="font-size:0.85rem; text-align:center;">ì•„ì§ ì‘ì„±ëœ ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                } else {
                    const roots = organizeCommentsTree(data.comments);
                    roots.forEach(c => {
                        const wrapper = document.createElement('div');
                        wrapper.innerHTML = renderCommentHtml(c, dreamId);
                        listContainer.appendChild(wrapper);
                    });
                }
            } catch (e) {
                listContainer.innerHTML = '<p style="color:red; font-size:0.8rem;">ëŒ“ê¸€ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>';
            }
        }

        async function submitComment(dreamId, parentId = null) {
            const inputId = parentId ? `reply-input-${parentId}` : `comment-input-${dreamId}`;
            const input = document.getElementById(inputId);
            const content = input.value;

            if (!content || content.trim() === '') {
                alert('ëŒ“ê¸€ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            const btn = input.nextElementSibling;
            btn.disabled = true;

            const payload = { content: content.trim() };
            if (parentId) payload.parent_id = parentId;

            try {
                const res = await authenticatedFetch(`${API_URL}/community/${dreamId}/comments`, {
                    method: 'POST',
                    body: JSON.stringify(payload)
                });

                if (res.ok) {
                    input.value = '';
                    await loadComments(dreamId); // Reload comments to show the new one
                } else {
                    const data = await res.json();
                    alert(data.error || 'ëŒ“ê¸€ ì‘ì„± ì‹¤íŒ¨');
                }
            } catch (e) {
                console.error('Comment error:', e);
                alert('ì„œë²„ ì˜¤ë¥˜ë¡œ ëŒ“ê¸€ ì‘ì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            } finally {
                btn.disabled = false;
            }
        }

        async function editComment(dreamId, commentId, btnElement) {
            const pElement = document.getElementById(`comment-text-${commentId}`);
            const originalContent = pElement.textContent;
            const newContent = prompt('ëŒ“ê¸€ ìˆ˜ì •:', originalContent);
            if (newContent === null || newContent.trim() === '' || newContent === originalContent) return;

            try {
                const res = await authenticatedFetch(`${API_URL}/community/comments/${commentId}`, {
                    method: 'PUT',
                    body: JSON.stringify({ content: newContent.trim() })
                });

                if (res.ok) {
                    await loadComments(dreamId);
                } else {
                    const data = await res.json();
                    alert(data.error || 'ëŒ“ê¸€ ìˆ˜ì • ì‹¤íŒ¨');
                }
            } catch (e) {
                alert('ì„œë²„ ì˜¤ë¥˜ë¡œ ëŒ“ê¸€ ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        }

        async function deleteComment(dreamId, commentId) {
            if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

            try {
                const res = await authenticatedFetch(`${API_URL}/community/comments/${commentId}`, {
                    method: 'DELETE'
                });

                if (res.ok) {
                    await loadComments(dreamId);
                } else {
                    const data = await res.json();
                    alert(data.error || 'ëŒ“ê¸€ ì‚­ì œ ì‹¤íŒ¨');
                }
            } catch (e) {
                alert('ì„œë²„ ì˜¤ë¥˜ë¡œ ëŒ“ê¸€ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        }

        async function deleteDream(dreamId) {
            if (!confirm('ì •ë§ë¡œ ì´ ê¿ˆ ê³µìœ ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

            try {
                const response = await fetch(`${API_URL}/dreams/${dreamId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('dream_token')}`
                    }
                });

                if (response.ok) {
                    loadCommunityDreams();
                } else {
                    const data = await response.json();
                    alert(data.error || 'ì‚­ì œ ì‹¤íŒ¨');
                }
            } catch (error) {
                console.error('Dream deletion error:', error);
                alert('ì„œë²„ ì˜¤ë¥˜ë¡œ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        }

        async function loadNoticeBoard() {
            showLoading('noticeList');
            try {
                const response = await fetch(`${API_URL}/posts`);
                const data = await response.json();

                if (!response.ok) throw new Error(data.error || 'Failed to load posts');

                const noticeList = document.getElementById('noticeList');
                noticeList.innerHTML = '';

                if (data.posts.length === 0) {
                    noticeList.innerHTML = `
                        <div class="card text-center" style="padding: 3rem;">
                            <h3>ğŸ“­ ì•„ì§ ë“±ë¡ëœ ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</h3>
                            <p class="text-muted">ì²« ë²ˆì§¸ ê¸€ì„ ì‘ì„±í•´ë³´ì„¸ìš”!</p>
                        </div>
                    `;
                    return;
                }

                data.posts.forEach((post, index) => {
                    const delay = index * 0.1;
                    const card = document.createElement('div');
                    card.className = 'card fade-in';
                    card.style.animationDelay = `${delay}s`;

                    const postDate = new Date(post.created_at).toLocaleString('ko-KR', {
                        year: 'numeric', month: '2-digit', day: '2-digit',
                        hour: '2-digit', minute: '2-digit'
                    });

                    const authorAvatarHtml = post.profile_image_url
                        ? `<img src="${post.profile_image_url}" alt="avatar" style="width: 24px; height: 24px; border-radius: 50%; object-fit: cover; vertical-align: middle; margin-right: 5px;">`
                        : 'ğŸ‘¤ ';

                    const currentUser = getUser();
                    const isOwner = currentUser && currentUser.id === post.user_id;
                    const isAdmin = currentUser && currentUser.is_admin;
                    let editDeleteHtml = '';

                    if (isOwner) {
                        editDeleteHtml = `
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn btn-outline btn-sm" onclick="editNoticePost(${post.id})" style="padding: 0.2rem 0.5rem;">ìˆ˜ì •</button>
                            <button class="btn btn-outline btn-sm" style="color: var(--color-error); border-color: var(--color-error); padding: 0.2rem 0.5rem;" onclick="deleteNoticePost(${post.id})">ì‚­ì œ</button>
                        </div>
                        `;
                    } else if (isAdmin) {
                        editDeleteHtml = `
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn btn-outline btn-sm" style="color: var(--color-error); border-color: var(--color-error); padding: 0.2rem 0.5rem;" onclick="deleteNoticePost(${post.id})">ì‚­ì œ</button>
                        </div>
                        `;
                    }

                    card.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem; border-bottom: 1px solid var(--glass-border); padding-bottom: 0.5rem;">
                            <div>
                                <h3 id="notice-title-${post.id}" style="margin: 0; color: var(--color-accent); font-size: 1.2rem;">${post.title}</h3>
                                <span class="text-muted" style="font-size: 0.85rem;">${postDate} â€¢ ${authorAvatarHtml}${post.display_name}</span>
                            </div>
                            ${editDeleteHtml}
                        </div>
                        <p id="notice-content-${post.id}" style="color: var(--color-text); line-height: 1.6; margin-top: 1rem; white-space: pre-wrap;">${post.content}</p>
                    `;
                    noticeList.appendChild(card);
                });

            } catch (error) {
                showError('noticeList', 'ê²Œì‹œê¸€ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                console.error(error);
            }
        }

        async function submitNoticePost(event) {
            event.preventDefault();

            if (!isAuthenticated()) {
                alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                return;
            }

            const titleInput = document.getElementById('noticeTitle');
            const contentInput = document.getElementById('noticeContent');
            const btn = document.getElementById('btnSubmitNotice');
            const msg = document.getElementById('noticePostMsg');

            const title = titleInput.value.trim();
            const content = contentInput.value.trim();
            const noticeId = document.getElementById('noticePostForm').dataset.editingId;

            if (!title || !content) return;

            btn.disabled = true;
            msg.textContent = '';

            try {
                let url = `${API_URL}/posts`;
                let method = 'POST';

                if (noticeId) {
                    url = `${API_URL}/posts/${noticeId}`;
                    method = 'PUT';
                }

                const res = await authenticatedFetch(url, {
                    method: method,
                    body: JSON.stringify({ title, content })
                });

                if (res.ok) {
                    titleInput.value = '';
                    contentInput.value = '';
                    msg.style.color = 'var(--color-success)';
                    msg.textContent = 'ê²Œì‹œê¸€ì´ ì„±ê³µì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.';
                    await loadNoticeBoard(); // Reload the list
                    setTimeout(() => {
                        msg.textContent = '';
                        closeNoticeModal();
                    }, 1000);
                } else {
                    const data = await res.json();
                    msg.style.color = 'var(--color-error)';
                    msg.textContent = data.error || 'ê¸€ ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
                }
            } catch (e) {
                console.error('Post error:', e);
                msg.style.color = 'var(--color-error)';
                msg.textContent = 'ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
            } finally {
                btn.disabled = false;
            }
        }

        function editNoticePost(postId) {
            const title = document.getElementById(`notice-title-${postId}`).textContent;
            const content = document.getElementById(`notice-content-${postId}`).textContent;

            document.getElementById('noticeTitle').value = title;
            document.getElementById('noticeContent').value = content;
            document.getElementById('noticePostMsg').textContent = '';
            document.getElementById('noticePostModal').classList.remove('hidden');

            // Mark form as editing
            document.getElementById('noticePostForm').dataset.editingId = postId;
        }

        async function deleteNoticePost(postId) {
            if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

            try {
                const res = await authenticatedFetch(`${API_URL}/posts/${postId}`, {
                    method: 'DELETE'
                });

                if (res.ok) {
                    await loadNoticeBoard();
                } else {
                    const data = await res.json();
                    alert(data.error || 'ê²Œì‹œê¸€ ì‚­ì œ ì‹¤íŒ¨');
                }
            } catch (e) {
                alert('ì„œë²„ ì˜¤ë¥˜ë¡œ ê²Œì‹œê¸€ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        }
    </script>
</body>

</html>