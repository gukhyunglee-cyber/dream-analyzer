<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ê¿ˆ ë¶„ì„ ê²°ê³¼ - ê¿ˆ ë¶„ì„ê¸°</title>
  <link rel="stylesheet" href="/styles/main.css">
</head>

<body>
  <!-- Navigation -->
  <nav class="navbar">
    <div class="navbar-content">
      <a href="/dashboard.html" class="navbar-brand">ğŸŒ™ ê¿ˆ ë¶„ì„ê¸°</a>
      <ul class="navbar-nav">
        <li><a href="/dashboard.html" class="navbar-link">ëŒ€ì‹œë³´ë“œ</a></li>
        <li><a href="/dream-journal.html" class="navbar-link">ê¿ˆ ì¼ì§€</a></li>
        <li><a href="#" class="navbar-link" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</a></li>
      </ul>
    </div>
  </nav>

  <div class="container" style="margin-top: 2rem;">
    <h1 class="mb-lg">ğŸ”® ê¿ˆ ë¶„ì„ ê²°ê³¼</h1>

    <!-- Dream Info -->
    <div id="dreamInfo" class="card mb-lg"></div>

    <!-- Analysis Section -->
    <div id="analysisSection"></div>

    <!-- Actions -->
    <div style="margin-top: 2rem; display: flex; gap: 1rem; flex-wrap: wrap;">
      <button onclick="window.location.href='/dashboard.html'" class="btn btn-outline" style="flex: 1;">ëŒ€ì‹œë³´ë“œë¡œ
        ëŒì•„ê°€ê¸°</button>
      <button onclick="window.location.href='/dream-journal.html'" class="btn btn-outline" style="flex: 1;">ê¿ˆ ì¼ì§€
        ë³´ê¸°</button>
      <button onclick="window.location.href=`/dream-input.html?dreamId=${dreamId}`" class="btn btn-primary"
        style="flex: 1;">âœï¸ ë‚´ìš© ìˆ˜ì •í•˜ê¸°</button>
    </div>
  </div>

  <script src="/js/app.js"></script>
  <script>
    // Check authentication
    if (!isAuthenticated()) {
      window.location.href = '/auth.html';
    }

    // Get dream ID from URL
    const urlParams = new URLSearchParams(window.location.search);
    const dreamId = urlParams.get('dreamId');
    const shouldAnalyze = urlParams.get('analyze') === 'true';

    if (!dreamId) {
      window.location.href = '/dashboard.html';
    }

    let currentDream = null;

    // Load dream details
    async function loadDreamDetails() {
      showLoading('dreamInfo');

      try {
        const response = await authenticatedFetch(`${API_URL}/dreams/${dreamId}`);
        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.error || 'ê¿ˆ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
        }

        currentDream = data.dream;

        // Display dream info
        document.getElementById('dreamInfo').innerHTML = `
          <h2>${currentDream.title}</h2>
          <p class="text-muted mb-md">${formatDate(currentDream.date)}</p>
          <p>${currentDream.content}</p>
          ${currentDream.emotions && currentDream.emotions.length > 0 ? `
            <div style="margin-top: 1rem;">
              <strong>ê°ì •:</strong>
              ${currentDream.emotions.map(e => `<span style="background: var(--color-primary-light); padding: 0.25rem 0.75rem; border-radius: 1rem; margin-right: 0.5rem; font-size: 0.9rem;">${e}</span>`).join('')}
            </div>
          ` : ''}
        `;

        // Load or perform analysis
        if (shouldAnalyze) {
          await performAnalysis();
        } else {
          await loadExistingAnalysis();
        }

      } catch (error) {
        showError('dreamInfo', error.message);
      }
    }

    // Perform new analysis
    async function performAnalysis() {
      const analysisSection = document.getElementById('analysisSection');
      analysisSection.innerHTML = `
        <div class="card card-premium">
          <h3 style="text-align: center;">ğŸ§  AIê°€ ê¿ˆì„ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤...</h3>
          <div class="loading" style="height: 200px; margin-top: 1rem;"></div>
          <p class="text-center text-muted" style="margin-top: 1rem;">ìœµ ì´ë¡ ì„ ë°”íƒ•ìœ¼ë¡œ ê¹Šì´ ìˆëŠ” ë¶„ì„ì„ ì§„í–‰ ì¤‘ì…ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.</p>
        </div>
      `;

      try {
        const response = await authenticatedFetch(`${API_URL}/analysis/analyze`, {
          method: 'POST',
          body: JSON.stringify({ dreamId })
        });

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.error || 'ë¶„ì„ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
        }

        displayAnalysis(data.analysis);

      } catch (error) {
        analysisSection.innerHTML = `
          <div class="card" style="background: rgba(255, 82, 82, 0.1); border-color: var(--color-error);">
            <h3 style="color: var(--color-error);">âš ï¸ ë¶„ì„ ì‹¤íŒ¨</h3>
            <p>${error.message}</p>
            <button onclick="performAnalysis()" class="btn btn-primary mt-md">ë‹¤ì‹œ ì‹œë„</button>
          </div>
        `;
      }
    }

    // Load existing analysis
    async function loadExistingAnalysis() {
      const analysisSection = document.getElementById('analysisSection');

      try {
        const response = await authenticatedFetch(`${API_URL}/analysis/${dreamId}`);

        if (!response.ok) {
          // No analysis exists, offer to create one
          analysisSection.innerHTML = `
            <div class="card text-center">
              <h3>ì´ ê¿ˆì€ ì•„ì§ ë¶„ì„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤</h3>
              <p class="text-muted">AIë¥¼ í†µí•´ ìœµ ì´ë¡  ê¸°ë°˜ì˜ ê¹Šì´ ìˆëŠ” ë¶„ì„ì„ ë°›ì•„ë³´ì„¸ìš”</p>
              <button onclick="performAnalysis()" class="btn btn-accent mt-md">ì§€ê¸ˆ ë¶„ì„í•˜ê¸°</button>
            </div>
          `;
          return;
        }

        const data = await response.json();
        displayAnalysis(data.analysis);

      } catch (error) {
        analysisSection.innerHTML = `
          <div class="card text-center">
            <h3>ì´ ê¿ˆì€ ì•„ì§ ë¶„ì„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤</h3>
            <p class="text-muted">AIë¥¼ í†µí•´ ìœµ ì´ë¡  ê¸°ë°˜ì˜ ê¹Šì´ ìˆëŠ” ë¶„ì„ì„ ë°›ì•„ë³´ì„¸ìš”</p>
            <button onclick="performAnalysis()" class="btn btn-accent mt-md">ì§€ê¸ˆ ë¶„ì„í•˜ê¸°</button>
          </div>
        `;
      }
    }

    // Display analysis results
    function displayAnalysis(analysis) {
      const analysisSection = document.getElementById('analysisSection');

      analysisSection.innerHTML = `
        <!-- Overall Interpretation -->
        <div class="card card-premium mb-lg fade-in">
          <h2 style="color: var(--color-accent); margin-bottom: 1rem;">ì „ì²´ í•´ì„</h2>
          <p style="line-height: 1.8; font-size: 1.05rem;">${analysis.overall_interpretation || analysis.analysis_text || 'ë¶„ì„ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.'}</p>
        </div>

        <!-- Archetypes -->
        ${analysis.archetypes && analysis.archetypes.length > 0 ? `
          <div class="card mb-lg fade-in" style="animation-delay: 0.2s;">
            <h2 style="color: var(--color-primary-light); margin-bottom: 1rem;">ğŸ­ ë°œê²¬ëœ ì›í˜• (Archetypes)</h2>
            <ul style="list-style: none; padding: 0;">
              ${analysis.archetypes.map(archetype => `
                <li style="background: var(--color-surface-light); padding: 1rem; border-radius: var(--radius-sm); margin-bottom: 0.5rem;">
                  ${archetype}
                </li>
              `).join('')}
            </ul>
          </div>
        ` : ''}

        <!-- Symbols -->
        ${analysis.symbols && Object.keys(analysis.symbols).length > 0 ? `
          <div class="card mb-lg fade-in" style="animation-delay: 0.4s;">
            <h2 style="color: var(--color-accent-light); margin-bottom: 1rem;">âœ¨ ìƒì§•ê³¼ ì˜ë¯¸</h2>
            <div style="display: grid; gap: 1rem;">
              ${Object.entries(analysis.symbols).map(([symbol, meaning]) => `
                <div style="background: var(--color-surface-light); padding: 1rem; border-radius: var(--radius-sm);">
                  <h4 style="color: var(--color-accent); margin-bottom: 0.5rem;">${symbol}</h4>
                  <p style="margin: 0;">${meaning}</p>
                </div>
              `).join('')}
            </div>
          </div>
        ` : ''}

        <!-- Psychological State -->
        ${analysis.psychological_state ? `
          <div class="card mb-lg fade-in" style="animation-delay: 0.6s;">
            <h2 style="color: var(--color-secondary-light); margin-bottom: 1rem;">ğŸ’­ í˜„ì¬ ì‹¬ë¦¬ ìƒíƒœ</h2>
            <p style="line-height: 1.8;">${analysis.psychological_state}</p>
          </div>
        ` : ''}

        <!-- Individuation Insights -->
        ${analysis.individuation_insights ? `
          <div class="card mb-lg fade-in" style="animation-delay: 0.8s;">
            <h2 style="color: var(--color-accent); margin-bottom: 1rem;">ğŸŒŸ ê°œì„±í™” ê³¼ì • ì¸ì‚¬ì´íŠ¸</h2>
            <p style="line-height: 1.8;">${analysis.individuation_insights}</p>
          </div>
        ` : ''}

        <!-- Recommendations -->
        ${analysis.recommendations ? `
          <div class="card card-premium fade-in" style="animation-delay: 1s;">
            <h2 style="color: var(--color-accent-light); margin-bottom: 1rem;">ğŸ’¡ ì„±ì°°ì„ ìœ„í•œ ì œì•ˆ</h2>
            <p style="line-height: 1.8;">${analysis.recommendations}</p>
          </div>
        ` : ''}
      `;
    }

    // Load dream on page load
    loadDreamDetails();
  </script>
</body>

</html>